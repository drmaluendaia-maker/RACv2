<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro y Lista de Triage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style> body { font-family: 'Inter', sans-serif; } .triage-button.selected { transform: scale(1.05); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.5); } .dot-rojo { background-color: #ef4444; } .dot-naranja { background-color: #f97316; } .dot-amarillo { background-color: #f59e0b; } .dot-verde { background-color: #10b981; } .dot-azul { background-color: #3b82f6; } .edit-triage-btn { transition: transform 0.2s; } .edit-triage-btn:hover { transform: scale(1.2); } .status-atendiendo { background-color: #3b82f6; color: white; } .status-ausente { background-color: #6b7280; color: white; } .status-pre_internacion { background-color: #a855f7; color: white; } </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="loginOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center p-4"><div class="bg-white p-8 rounded-lg shadow-2xl text-center w-full max-w-sm"><h2 class="text-2xl font-bold mb-4">Acceso a Registro</h2><form id="loginForm"><input type="text" id="userInput" class="w-full px-4 py-3 border rounded-lg mb-4 text-center" placeholder="Usuario (ej: admin)"><input type="password" id="passwordInput" class="w-full px-4 py-3 border rounded-lg mb-4 text-center" placeholder="••••••••"><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg">Ingresar</button><p id="loginError" class="text-red-500 text-sm mt-2 h-4"></p></form></div></div>
    <div id="emergencyConfirmModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4"><div class="bg-white p-8 rounded-lg shadow-2xl text-center w-full max-w-md"><h2 class="text-2xl font-bold mb-4 text-red-600">Confirmar Emergencia</h2><p class="text-gray-600 mb-6">¿Estás seguro de que deseas activar el protocolo de emergencia?</p><div class="flex justify-center gap-4"><button id="confirmEmergencyBtn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Sí, Activar</button><button id="cancelEmergencyBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button></div></div></div>
    <div id="historyModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4"><div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-2xl"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Historial del Paciente</h2><button id="closeHistoryBtn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button></div><div id="historyResults" class="max-h-80 overflow-y-auto space-y-3"></div></div></div>
    <div id="appContent" class="opacity-0 transition-opacity duration-500 p-8">
        <div class="container mx-auto mb-6 flex justify-end gap-4"><button id="startEmergencyBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg">Activar Emergencia</button><button id="endEmergencyBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg hidden">Finalizar Emergencia</button></div>
        <div class="container mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-2xl shadow-2xl p-8 self-start"><h1 class="text-4xl font-bold text-center mb-6">Registro de Pacientes</h1><form id="triageForm" class="space-y-6"><div><label for="patientName" class="block text-sm font-medium text-gray-700 mb-2">Nombre y Apellido</label><input type="text" id="patientName" required class="w-full px-4 py-3 border rounded-lg uppercase"></div><div><label for="patientDNI" class="block text-sm font-medium text-gray-700 mb-2">DNI</label><input type="text" id="patientDNI" class="w-full px-4 py-3 border rounded-lg" placeholder="Sin puntos ni espacios"></div><div class="relative"><label for="observationSearch" class="block text-sm font-medium text-gray-700 mb-2">Buscar Observación (Preset)</label><input type="text" id="observationSearch" class="w-full px-4 py-3 border rounded-lg" placeholder="Ej: Tos, Dolor..."><div id="presetsDropdown" class="hidden absolute w-full bg-white border mt-1 rounded-lg shadow-lg max-h-48 overflow-y-auto z-10"></div></div><div><label for="patientNotes" class="block text-sm font-medium text-gray-700 mb-2">Notas de Enfermería</label><textarea id="patientNotes" rows="3" class="w-full px-4 py-3 border rounded-lg"></textarea></div><div><span class="block text-sm font-medium text-gray-700 mb-2">Nivel de Triage</span><div class="grid grid-cols-2 sm:grid-cols-3 gap-4"><button type="button" data-level="rojo" class="triage-button text-white font-bold py-4 rounded-lg bg-red-600">Nivel 1</button><button type="button" data-level="naranja" class="triage-button text-white font-bold py-4 rounded-lg bg-orange-500">Nivel 2</button><button type="button" data-level="amarillo" class="triage-button text-white font-bold py-4 rounded-lg bg-yellow-500">Nivel 3</button><button type="button" data-level="verde" class="triage-button text-white font-bold py-4 rounded-lg bg-green-600">Nivel 4</button><button type="button" data-level="azul" class="triage-button text-white font-bold py-4 rounded-lg bg-blue-600">Nivel 5</button></div></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-lg">Registrar Paciente</button></form></div>
            <div class="bg-white rounded-2xl shadow-2xl p-8"><h2 class="text-4xl font-bold text-center mb-6">Pacientes en Espera</h2><div id="patientList" class="space-y-4 h-[calc(60vh+50px)] overflow-y-auto pr-2"><p id="noPatientsMessage" class="text-center text-gray-500 mt-8">No hay pacientes en espera.</p></div></div>
        </div>
        <div class="container mx-auto mt-8 bg-white rounded-2xl shadow-2xl p-8"><div class="flex justify-between items-center mb-4"><h2 class="text-3xl font-bold">Pacientes Atendidos en mi Turno</h2><div class="flex gap-2"><button id="exportXLS" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Exportar XLS</button><button id="exportPDF" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Exportar PDF</button></div></div><div class="h-64 overflow-y-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ingreso</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Espera (min)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notas</th></tr></thead><tbody id="attendedHistoryList" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io(); const loginOverlay = document.getElementById('loginOverlay'); const loginForm = document.getElementById('loginForm'); const userInput = document.getElementById('userInput'); const passwordInput = document.getElementById('passwordInput'); const loginError = document.getElementById('loginError'); const appContent = document.getElementById('appContent'); const emergencyModal = document.getElementById('emergencyConfirmModal'); const confirmEmergencyBtn = document.getElementById('confirmEmergencyBtn'); const cancelEmergencyBtn = document.getElementById('cancelEmergencyBtn'); const triageForm = document.getElementById('triageForm'); const patientNameInput = document.getElementById('patientName'); const patientNotesInput = document.getElementById('patientNotes'); const patientDNIInput = document.getElementById('patientDNI'); const triageButtons = document.querySelectorAll('.triage-button'); const patientList = document.getElementById('patientList'); const noPatientsMessage = document.getElementById('noPatientsMessage'); const startEmergencyBtn = document.getElementById('startEmergencyBtn'); const endEmergencyBtn = document.getElementById('endEmergencyBtn'); const attendedHistoryList = document.getElementById('attendedHistoryList'); const exportXLSBtn = document.getElementById('exportXLS'); const exportPDFBtn = document.getElementById('exportPDF'); const historyModal = document.getElementById('historyModal'); const historyResults = document.getElementById('historyResults'); const closeHistoryBtn = document.getElementById('closeHistoryBtn'); const observationSearch = document.getElementById('observationSearch'); const presetsDropdown = document.getElementById('presetsDropdown');
            let selectedLevel = null; let attendedHistoryData = []; let searchTimeout; let observationPresets = [];
            patientNameInput.addEventListener('input', function() { this.value = this.value.toUpperCase(); });
            loginForm.addEventListener('submit', (e) => { e.preventDefault(); socket.emit('authenticate_user', { user: userInput.value, pass: passwordInput.value }); });
            socket.on('auth_success', (data) => { if (data.role === 'registro') { loginOverlay.style.display = 'none'; appContent.classList.remove('opacity-0'); socket.emit('get_attended_history'); } else { loginError.textContent = 'Acceso no autorizado para este rol.'; } });
            socket.on('auth_fail', () => { loginError.textContent = 'Usuario o contraseña incorrectos.'; });
            function renderPatientList(patients) { patientList.innerHTML = ''; if (patients.length === 0) { patientList.appendChild(noPatientsMessage); } else { patients.forEach(patient => { const arrivalTime = new Date(patient.horaLlegada).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); const waitTime = Math.floor((Date.now() - patient.horaLlegada) / 60000); const patientDiv = document.createElement('div'); patientDiv.className = 'bg-gray-50 p-4 rounded-lg shadow'; let statusBadge = ''; if (patient.status === 'atendiendo') statusBadge = `<span class="status-atendiendo text-xs font-bold uppercase px-2 py-1 rounded-full">Atendiendo</span>`; if (patient.status === 'ausente') statusBadge = `<span class="status-ausente text-xs font-bold uppercase px-2 py-1 rounded-full">Ausente</span>`; if (patient.status === 'pre_internacion') statusBadge = `<span class="status-pre_internacion text-xs font-bold uppercase px-2 py-1 rounded-full">Pre-internación</span>`; let nurseEvolutionsHTML = '<div class="mt-4 border-t pt-2">'; if (patient.nurseEvolutions && patient.nurseEvolutions.length > 0) { nurseEvolutionsHTML += '<h4 class="text-sm font-bold mb-2">Evoluciones de Enfermería:</h4><div class="space-y-2">'; patient.nurseEvolutions.forEach(note => { const noteTime = new Date(note.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); nurseEvolutionsHTML += `<div class="text-xs bg-yellow-50 p-2 rounded"><p>${note.text}</p><p class="text-right text-gray-500 font-semibold">- ${note.user} (${noteTime})</p></div>`; }); nurseEvolutionsHTML += '</div>'; } nurseEvolutionsHTML += `<form class="add-evolution-form mt-2 flex gap-2" data-id="${patient.id}"><textarea class="w-full text-sm border rounded p-1" rows="2" placeholder="Añadir evolución..."></textarea><button type="submit" class="bg-yellow-500 text-white rounded px-3 text-sm font-bold">Guardar</button></form></div>`; patientDiv.innerHTML = `<div class="flex items-start justify-between"><div class="flex items-start gap-4"><div class="w-3 h-3 rounded-full dot-${patient.nivelTriage} mt-2 flex-shrink-0"></div><div class="flex-grow"><div class="flex items-center gap-3 flex-wrap"><p class="font-bold text-lg">${patient.nombre}</p>${statusBadge}</div><p class="text-sm text-gray-500">Ingreso: ${arrivalTime}</p><p class="text-sm text-gray-500">Espera: ${waitTime} min</p>${patient.notas ? `<p class="text-xs text-gray-600 mt-2 italic bg-gray-200 p-2 rounded w-full break-words"><b>Nota de Ingreso:</b> ${patient.notas}</p>` : ''}</div></div><button data-id="${patient.id}" class="delete-button bg-red-100 text-red-700 font-semibold py-1 px-2 rounded text-xs hover:bg-red-200 ml-2">Dar de Alta</button></div><div class="flex items-center gap-3 mt-3 pl-7"><span class="text-xs font-semibold">Cambiar Nivel:</span><span class="edit-triage-btn cursor-pointer w-4 h-4 rounded-full dot-rojo" data-id="${patient.id}" data-level="rojo"></span><span class="edit-triage-btn cursor-pointer w-4 h-4 rounded-full dot-naranja" data-id="${patient.id}" data-level="naranja"></span><span class="edit-triage-btn cursor-pointer w-4 h-4 rounded-full dot-amarillo" data-id="${patient.id}" data-level="amarillo"></span><span class="edit-triage-btn cursor-pointer w-4 h-4 rounded-full dot-verde" data-id="${patient.id}" data-level="verde"></span><span class="edit-triage-btn cursor-pointer w-4 h-4 rounded-full dot-azul" data-id="${patient.id}" data-level="azul"></span></div>${nurseEvolutionsHTML}`; patientList.appendChild(patientDiv); }); } }
            function renderAttendedList(history) { attendedHistoryData = history; attendedHistoryList.innerHTML = ''; history.forEach((p, index) => { const row = document.createElement('tr'); const arrivalTime = new Date(p.horaLlegada).toLocaleString('es-ES'); const waitTime = Math.round((p.attendedAt - p.horaLlegada) / 60000); row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap">${index + 1}</td><td class="px-6 py-4 whitespace-nowrap">${p.nombre}</td><td class="px-6 py-4 whitespace-nowrap">${arrivalTime}</td><td class="px-6 py-4 whitespace-nowrap">${waitTime}</td><td class="px-6 py-4 break-words">${p.notas}</td>`; attendedHistoryList.appendChild(row); }); }
            socket.on('update_patient_list', (patients) => { renderPatientList(patients); socket.emit('get_attended_history'); });
            socket.on('attended_history_update', renderAttendedList);
            socket.on('emergency_status_update', (isEmergency) => { startEmergencyBtn.classList.toggle('hidden', isEmergency); endEmergencyBtn.classList.toggle('hidden', !isEmergency); });
            triageButtons.forEach(button => { button.addEventListener('click', () => { triageButtons.forEach(btn => btn.classList.remove('selected')); button.classList.add('selected'); selectedLevel = button.dataset.level; }); });
            triageForm.addEventListener('submit', (e) => { e.preventDefault(); if (!patientNameInput.value.trim() || !selectedLevel) { alert("Complete nombre y nivel."); return; } const newPatient = { id: Date.now(), nombre: patientNameInput.value.trim(), dni: patientDNIInput.value.trim(), notas: patientNotesInput.value.trim(), nivelTriage: selectedLevel, ordenTriage: { 'rojo': 1, 'naranja': 2, 'amarillo': 3, 'verde': 4, 'azul': 5 }[selectedLevel], horaLlegada: Date.now(), status: 'en_espera' }; socket.emit('register_patient', newPatient); triageForm.reset(); triageButtons.forEach(btn => btn.classList.remove('selected')); selectedLevel = null; patientNameInput.focus(); });
            patientList.addEventListener('click', (e) => { const target = e.target; const patientId = parseInt(target.closest('[data-id]')?.dataset.id); if (!patientId) return; if (target.classList.contains('delete-button')) socket.emit('mark_as_attended', { patientId: patientId, attendedBy: userInput.value }); if (target.classList.contains('edit-triage-btn')) socket.emit('update_patient_level', { id: patientId, newLevel: target.dataset.level }); if (target.closest('.add-evolution-form')) { e.preventDefault(); const form = target.closest('.add-evolution-form'); const textarea = form.querySelector('textarea'); const noteText = textarea.value.trim(); if (noteText) { socket.emit('add_nurse_evolution', { id: patientId, note: noteText }); textarea.value = ''; } } });
            startEmergencyBtn.addEventListener('click', () => emergencyModal.classList.remove('hidden')); endEmergencyBtn.addEventListener('click', () => socket.emit('end_emergency')); cancelEmergencyBtn.addEventListener('click', () => emergencyModal.classList.add('hidden')); confirmEmergencyBtn.addEventListener('click', () => { socket.emit('start_emergency'); emergencyModal.classList.add('hidden'); });
            exportXLSBtn.addEventListener('click', () => { const dataToExport = attendedHistoryData.map((p, i) => ({ '#': i + 1, Nombre: p.nombre, Observaciones: p.notas, 'Hora de Carga': new Date(p.horaLlegada).toLocaleString('es-ES'), 'Tiempo de Espera (min)': Math.round((p.attendedAt - p.horaLlegada) / 60000) })); const worksheet = XLSX.utils.json_to_sheet(dataToExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Pacientes Atendidos"); XLSX.writeFile(workbook, "ReporteTurnoEnfermeria.xlsx"); });
            exportPDFBtn.addEventListener('click', () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.autoTable({ head: [['#', 'Nombre', 'Observaciones', 'Hora de Carga', 'Espera (min)']], body: attendedHistoryData.map((p, i) => [i + 1, p.nombre, p.notas, new Date(p.horaLlegada).toLocaleString('es-ES'), Math.round((p.attendedAt - p.horaLlegada) / 60000)]) }); doc.save('ReporteTurnoEnfermeria.pdf'); });
            const handleSearch = (event) => { clearTimeout(searchTimeout); const query = event.target.value; if (query.length < 3) { historyModal.classList.add('hidden'); return; } searchTimeout = setTimeout(() => { socket.emit('search_patient_history', { query, role: 'registro' }); }, 500); };
            patientDNIInput.addEventListener('keyup', handleSearch); patientNameInput.addEventListener('keyup', handleSearch);
            socket.on('patient_history_result', (results) => { if (results && results.length > 0) { historyResults.innerHTML = ''; results.forEach(p => { const visitDiv = document.createElement('div'); visitDiv.className = 'bg-gray-100 p-3 rounded-md cursor-pointer hover:bg-gray-200'; visitDiv.innerHTML = `<div class="flex items-center justify-between"><p class="font-bold">${p.nombre} <span class="font-normal text-gray-600">- DNI: ${p.dni || 'N/A'}</span></p><div class="flex items-center gap-2"><span class="text-xs font-semibold">${new Date(p.attendedAt).toLocaleDateString('es-ES')}</span><div class="w-3 h-3 rounded-full dot-${p.nivelTriage}"></div></div></div><p class="text-sm mt-1 text-gray-700"><b>Notas de Enfermería:</b> ${p.notas || 'Sin notas.'}</p>`; visitDiv.addEventListener('click', () => { patientNameInput.value = p.nombre.toUpperCase(); patientDNIInput.value = p.dni || ''; patientNotesInput.value = ''; historyModal.classList.add('hidden'); }); historyResults.appendChild(visitDiv); }); historyModal.classList.remove('hidden'); } else { historyModal.classList.add('hidden'); } });
            closeHistoryBtn.addEventListener('click', () => { historyModal.classList.add('hidden'); });
            socket.on('presets_update', (presets) => { observationPresets = presets; });
            observationSearch.addEventListener('input', () => {
                const query = observationSearch.value.toLowerCase();
                if (query.length < 2) { presetsDropdown.innerHTML = ''; presetsDropdown.classList.add('hidden'); return; }
                const filtered = observationPresets.filter(p => p.text.toLowerCase().includes(query));
                presetsDropdown.innerHTML = '';
                if (filtered.length > 0) {
                    filtered.forEach(preset => {
                        const item = document.createElement('div');
                        item.className = 'p-2 hover:bg-gray-100 cursor-pointer flex items-center gap-2';
                        item.innerHTML = `<div class="w-3 h-3 rounded-full dot-${preset.level}"></div><span>${preset.text}</span>`;
                        item.addEventListener('click', () => {
                            patientNotesInput.value += (patientNotesInput.value ? ', ' : '') + preset.text;
                            observationSearch.value = '';
                            presetsDropdown.classList.add('hidden');
                            triageButtons.forEach(btn => { btn.classList.remove('selected'); if (btn.dataset.level === preset.level) { btn.classList.add('selected'); selectedLevel = preset.level; } });
                        });
                        presetsDropdown.appendChild(item);
                    });
                    presetsDropdown.classList.remove('hidden');
                } else {
                    presetsDropdown.classList.add('hidden');
                }
            });
            document.addEventListener('click', (e) => { if (!observationSearch.contains(e.target) && !presetsDropdown.contains(e.target)) { presetsDropdown.classList.add('hidden'); } });
        });
    </script>
</body>
</html>
